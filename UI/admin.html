<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmasync - Admin</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <a href="cliente.html">Cliente</a>
        <button class="active">Admin</button>
    </nav>
    <br><br>

    <div class="chat-section">
        <h3>Agente Admin</h3>
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will appear here -->
        </div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Escribe tu mensaje...">
            <button id="send-message">▶</button>
        </div>
    </div>
<div class="container">
    <div class="table-container" id="tableContainer">
        <!-- Dynamic tables will be inserted here -->
    </div>
</div>

    <script>
    async function fetchChatbotResponse(message) {
        try {
            const response = await fetch('http://127.0.0.1:5000/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ consulta: message })
            });
            if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('Error:', error);
            return null;
        }
    }

    function addMessage(text, isUser = false) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = isUser ? 'user-message' : 'agent-message';
        messageDiv.textContent = text;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    let isLoading = false;

    function showLoading(container) {
        const loader = document.createElement('div');
        loader.className = 'loading-spinner';
        container.appendChild(loader);
    }

    function showError(container, message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        container.appendChild(errorDiv);
    }

    function createTable(data, type) {
        console.log('Iniciando createTable con tipo:', type);
        console.log('Datos recibidos:', data);

        const container = document.getElementById('tableContainer');
        container.innerHTML = ''; // Clear existing content

        // Create title based on table type
        const title = document.createElement('h2');
        title.className = 'table-title';
        switch(type) {
            case 'ventas':
                title.textContent = 'Registro de Ventas';
                break;
            case 'historial':
                title.textContent = 'Historial de Ventas';
                break;
            case 'detalle':
                title.textContent = 'Detalle de Venta';
                break;
            default:
                title.textContent = 'Resultados';
        }
        container.appendChild(title);

        if (isLoading) {
            showLoading(container);
            return;
        }

        // Asegurar que data sea un array y no esté vacío
        if (!Array.isArray(data) || data.length === 0 || !data[0]) {
            const noDataDiv = document.createElement('div');
            noDataDiv.className = 'no-data';
            noDataDiv.innerHTML = `
                <svg class="no-data-icon" viewBox="0 0 24 24">
                    <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
                </svg>
                <p>No se encontraron datos.</p>
            `;
            container.appendChild(noDataDiv);
            return;
        }

        const table = document.createElement('table');
        table.className = 'table';

        // Crear encabezados basados en el primer objeto
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        // Definir encabezados y sus correspondientes claves en los datos
        let headerConfig;
        console.log('Creando tabla de tipo:', type);
        switch(type) {
            case 'ventas':
            case 'detalle':
                headerConfig = [
                    { display: 'ID Venta', key: 'id_venta' },
                    { display: 'Vendedor', key: 'id_vendedor' },
                    { display: 'Cliente', key: 'id_cliente' },
                    { display: 'Fecha', key: 'fecha_venta' },
                    { display: 'Total', key: 'total' }
                ];
                break;
            case 'historial':
                headerConfig = [
                    { display: 'ID Historial', key: 'id_historial' },
                    { display: 'ID Venta', key: 'id_venta' },
                    { display: 'Fecha', key: 'fecha_venta' },
                    { display: 'Tipo', key: 'tipo_venta' },
                    { display: 'Usuario', key: 'id_usuario' },
                    { display: 'Observación', key: 'observacion' }
                ];
                break;
            default:
                // Si no hay tipo específico, usar las claves del objeto
                console.log('Usando claves del objeto como headers:', data[0]);
                headerConfig = Object.keys(data[0]).map(key => ({
                    display: key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' '),
                    key: key
                }));
        }
        
        const headers = headerConfig.map(h => h.display);
        
        // Crear los encabezados
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header.charAt(0).toUpperCase() + header.slice(1).replace(/_/g, ' ');
            headerRow.appendChild(th);
        });
        if (type === 'ventas') {
            const th = document.createElement('th');
            th.textContent = 'Acciones';
            headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Crear filas de datos
        const tbody = document.createElement('tbody');
        data.forEach(item => {
            const row = document.createElement('tr');
            
            // Obtener los valores según los encabezados
            console.log('Procesando item:', item);
            headerConfig.forEach(header => {
                const td = document.createElement('td');
                // Usar la configuración de cabecera para obtener el valor
                let value = item[header.key];
                
                console.log(`Buscando valor para ${header.display} (${header.key}):`, value);
                
                // Formatear el valor según su tipo
                if (typeof value === 'number' && !Number.isInteger(value)) {
                    td.textContent = value.toLocaleString('es-CO', { 
                        style: 'currency', 
                        currency: 'COP' 
                    });
                } else if (value instanceof Date || (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/))) {
                    // Formatear fechas
                    const fecha = new Date(value);
                    if (!isNaN(fecha)) {
                        td.textContent = fecha.toLocaleString('es-CO');
                    } else {
                        td.textContent = value;
                    }
                } else {
                    td.textContent = value || '-';
                }
                row.appendChild(td);
            });

            // Agregar botones de acción para ventas
            if (type === 'ventas') {
                const td = document.createElement('td');
                td.innerHTML = `
                    <button class="btn-edit" onclick="editVenta(${item.id_venta || item.id})">Editar</button>
                    <button class="btn-delete" onclick="deleteVenta(${item.id_venta || item.id})">Eliminar</button>
                `;
                row.appendChild(td);
            }
            tbody.appendChild(row);
        });
        table.appendChild(tbody);
        container.appendChild(table);
    }

    async function handleChatbotResponse(response) {
        console.log('Respuesta completa del chatbot:', response);
        
        const container = document.getElementById('tableContainer');
        isLoading = false;
        
        if (!response) {
            addMessage('Lo siento, hubo un error al procesar tu solicitud.', false);
            showError(container, 'Error al procesar la solicitud. Por favor, intenta de nuevo.');
            return;
        }

        // Log detallado de la estructura de datos
        if (response.data) {
            console.log('Herramienta utilizada:', response.data.tool);
            console.log('Resultado recibido:', response.data.result);
        }

        try {
            const data = response.data;
            
            if (data && data.result) {
                console.log('Datos recibidos:', data);
                // Determine data type based on response
                let type = 'default';
                if (data.tool === 'get_sales') type = 'ventas';
                if (data.tool === 'get_sales_history') type = 'historial';
                if (data.tool === 'get_sale_by_id' || data.tool === 'get_sale_details') type = 'detalle';
                
                // Para get_sale_by_id, necesitamos convertir el objeto único en un array
                let tableData;
                if (data.tool === 'get_sale_by_id') {
                    console.log('Procesando venta individual:', data.result);
                    if (data.result) {
                        // Asegurar que tengamos todos los campos necesarios
                        const ventaFormateada = {
                            'id_venta': data.result.id_venta,
                            'id_vendedor': data.result.id_vendedor,
                            'id_cliente': data.result.id_cliente,
                            'fecha_venta': data.result.fecha_venta,
                            'total': parseFloat(data.result.total)
                        };
                        tableData = [ventaFormateada];
                        console.log('Venta formateada:', ventaFormateada);
                    } else {
                        tableData = [];
                        console.log('No se encontraron datos de la venta');
                    }
                } else {
                    tableData = Array.isArray(data.result) ? data.result : [];
                }
                
                if (data.tool === 'get_sale_by_id') {
                    if (tableData && tableData.length > 0) {
                        addMessage('Aquí tienes los detalles de la venta solicitada:', false);
                        createTable(tableData, type);
                    } else {
                        addMessage('No se encontró la venta con el ID especificado.', false);
                        const container = document.getElementById('tableContainer');
                        const noDataDiv = document.createElement('div');
                        noDataDiv.className = 'no-data';
                        noDataDiv.innerHTML = `
                            <svg class="no-data-icon" viewBox="0 0 24 24">
                                <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
                            </svg>
                            <p>Venta no encontrada</p>
                        `;
                        container.appendChild(noDataDiv);
                    }
                } else {
                    createTable(tableData, type);
                    if (tableData && tableData.length > 0) {
                        addMessage('Aquí tienes la información solicitada:', false);
                    } else {
                        addMessage('No se encontraron resultados.', false);
                    }
                }
            } else if (typeof data === 'string') {
                addMessage(data, false);
            } else {
                addMessage('No se encontraron resultados para tu consulta.', false);
            }
        } catch (error) {
            console.error('Error processing response:', error);
            addMessage('Ocurrió un error al procesar la respuesta.', false);
            showError(container, 'Error al procesar los datos. Por favor, intenta de nuevo.');
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-message');

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                addMessage(message, true);
                chatInput.value = '';
                
                const container = document.getElementById('tableContainer');
                isLoading = true;
                createTable(null, 'default'); // This will show the loading spinner
                
                try {
                    const response = await fetchChatbotResponse(message);
                    handleChatbotResponse(response);
                } catch (error) {
                    console.error('Error sending message:', error);
                    isLoading = false;
                    addMessage('Error al enviar el mensaje. Por favor, intenta de nuevo.', false);
                    showError(container, 'Error de comunicación con el servidor.');
                }
            }
        }

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);

        // Initial greeting
        addMessage('¡Hola! Soy el agente administrativo. ¿En qué puedo ayudarte?', false);
    });

    async function editVenta(id) {
        const confirmed = await showConfirmDialog(
            'Editar Venta',
            '¿Deseas editar esta venta?',
            'Editar',
            'Cancelar'
        );
        
        if (confirmed) {
            try {
                const response = await fetchChatbotResponse(`editar venta ${id}`);
                if (response && response.data) {
                    showToast('Venta editada exitosamente', 'success');
                    // Refresh the table
                    const refreshResponse = await fetchChatbotResponse('mostrar ventas');
                    handleChatbotResponse(refreshResponse);
                } else {
                    throw new Error('Error al editar la venta');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al editar la venta', 'error');
            }
        }
    }

    async function deleteVenta(id) {
        const confirmed = await showConfirmDialog(
            'Eliminar Venta',
            '¿Estás seguro de que deseas eliminar esta venta? Esta acción no se puede deshacer.',
            'Eliminar',
            'Cancelar'
        );
        
        if (confirmed) {
            try {
                const response = await fetchChatbotResponse(`eliminar venta ${id}`);
                if (response && response.data) {
                    showToast('Venta eliminada exitosamente', 'success');
                    // Refresh the table
                    const refreshResponse = await fetchChatbotResponse('mostrar ventas');
                    handleChatbotResponse(refreshResponse);
                } else {
                    throw new Error('Error al eliminar la venta');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al eliminar la venta', 'error');
            }
        }
    }

    function showConfirmDialog(title, message, confirmText, cancelText) {
        return new Promise((resolve) => {
            const dialog = document.createElement('div');
            dialog.className = 'dialog-overlay';
            dialog.innerHTML = `
                <div class="dialog">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <div class="dialog-buttons">
                        <button class="btn-primary" id="confirmBtn">${confirmText}</button>
                        <button class="btn-secondary" id="cancelBtn">${cancelText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            function cleanup() {
                document.body.removeChild(dialog);
            }
            
            dialog.querySelector('#confirmBtn').addEventListener('click', () => {
                cleanup();
                resolve(true);
            });
            
            dialog.querySelector('#cancelBtn').addEventListener('click', () => {
                cleanup();
                resolve(false);
            });
        });
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // Trigger reflow
        toast.offsetHeight;
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
    </script>

    <style>
    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .dialog {
        background: white;
        padding: 24px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .dialog h3 {
        margin: 0 0 16px 0;
        color: #2c3e50;
    }

    .dialog p {
        margin: 0 0 24px 0;
        color: #666;
    }

    .dialog-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn-primary {
        background: #01B6BC;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-secondary {
        background: #e0e0e0;
        color: #333;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-primary:hover {
        background: #008080;
    }

    .btn-secondary:hover {
        background: #d0d0d0;
    }

    .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        padding: 12px 24px;
        border-radius: 6px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        opacity: 0;
        transition: transform 0.3s, opacity 0.3s;
        z-index: 1000;
    }

    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .toast-success {
        background: #27ae60;
    }

    .toast-error {
        background: #e74c3c;
    }

    .toast-info {
        background: #3498db;
    }
    </style>
</body>
</html>
